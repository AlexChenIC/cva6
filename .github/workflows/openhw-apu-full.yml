# Copyright 2026 OpenHW Group
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

# OpenHW Full APU Test Suite
# Comprehensive Verilator regression tests for CVA6 APU configurations
#
# Test coverage (all Verilator-compatible test suites):
#   RV64 (cv64a6_imafdc_sv39):
#     - smoke-tests          : Quick sanity check (~5 tests)
#     - dv-riscv-arch-test   : RISC-V architecture compliance (~221 tests)
#     - dv-riscv-tests       : Standard RISC-V tests, p+v mode (~229 tests)
#     - dv-riscv-compliance  : RISC-V compliance suite (~183 tests)
#     - cv64a6_imafdc_tests  : CVA6-specific directed tests (~6 tests)
#     - benchmark            : Performance benchmarks (~12 programs)
#
#   RV32 (cv32a65x):
#     - smoke-tests          : Quick sanity check (~1 test)
#     - dv-riscv-arch-test   : RISC-V architecture compliance (~105 tests)
#     - dv-riscv-tests       : Standard RISC-V tests, p-mode only (~94 tests)
#     - dv-riscv-compliance  : RISC-V compliance suite (~183 tests)
#     - cv32a6_tests         : CVA6-specific directed tests (~6 tests)
#     - dv-riscv-csr-access-test : CSR access verification tests
#     - benchmark            : Performance benchmarks (~12 programs)
#
#   Total: ~1057+ individual tests across 13 parallel jobs
#
# Not included (require VCS-UVM, not Verilator-compatible):
#   - dv-generated-tests, dv-generated-xif-tests, dv-interrupt-test
#   - smoke-gen_tests, debug_test, pmp_cv32a65x_tests
#   - dhrystone, coremark (hwconfig mode)
#   - cvxif_verif_regression

name: openhw-apu-full

on:
  # Manual trigger - primary usage
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'Target architecture to test'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - rv32
          - rv64
  # TEMP: Enable push trigger for testing (remove after validation)
  push:
    branches:
      - 'task/**'
      - 'feature/**'
      - 'openhw/**'
  # Scheduled weekly regression (optional - uncomment to enable)
  # schedule:
  #   - cron: '0 2 * * 0'  # Every Sunday at 2:00 AM UTC

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SPIKE_TANDEM: 1
  NUM_JOBS: 8

jobs:
  # ============================================================
  # Stage 1: Setup and cache tools
  # ============================================================
  setup-tools:
    name: Setup Tools
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup CVA6 Environment
        uses: ./.github/actions/setup-cva6-env
        with:
          install-tools: 'true'

  # ============================================================
  # Stage 2: RV64 Test Execution (parallel matrix jobs)
  # ============================================================
  execute-rv64-tests:
    name: RV64 ${{ matrix.testcase }}
    runs-on: ubuntu-latest
    needs: setup-tools
    if: (github.event.inputs.target_arch || 'both') == 'both' || (github.event.inputs.target_arch || 'both') == 'rv64'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Smoke tests - quick sanity check
          - testcase: smoke-tests-cv64a6_imafdc_sv39
            config: cv64a6_imafdc_sv39
          # Architecture compliance tests (~221 tests)
          - testcase: dv-riscv-arch-test
            config: cv64a6_imafdc_sv39
          # Standard RISC-V tests - p-mode + v-mode (~229 tests)
          - testcase: dv-riscv-tests
            config: cv64a6_imafdc_sv39
          # RISC-V compliance suite (~183 tests)
          - testcase: dv-riscv-compliance
            config: cv64a6_imafdc_sv39
          # CVA6-specific directed tests (~6 tests)
          - testcase: cv64a6_imafdc_tests
            config: cv64a6_imafdc_sv39
          # Performance benchmarks (~12 programs)
          - testcase: benchmark
            config: cv64a6_imafdc_sv39
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup CVA6 Environment
        uses: ./.github/actions/setup-cva6-env

      - name: Install prerequisites
        run: source ci/install-prereq.sh

      - name: Run ${{ matrix.testcase }}
        run: |
          set -x
          source verif/sim/setup-env.sh
          DV_SIMULATORS=veri-testharness,spike \
          DV_TARGET=${{ matrix.config }} \
            bash verif/regress/${{ matrix.testcase }}.sh

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rv64-${{ matrix.config }}-${{ matrix.testcase }}
          path: verif/sim/out*/
          retention-days: 14

  # ============================================================
  # Stage 3: RV32 Test Execution (parallel matrix jobs)
  # ============================================================
  execute-rv32-tests:
    name: RV32 ${{ matrix.testcase }}
    runs-on: ubuntu-latest
    needs: setup-tools
    if: (github.event.inputs.target_arch || 'both') == 'both' || (github.event.inputs.target_arch || 'both') == 'rv32'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Smoke tests - quick sanity check
          - testcase: smoke-tests-cv32a65x
            config: cv32a65x
          # Architecture compliance tests (~105 tests)
          - testcase: dv-riscv-arch-test
            config: cv32a65x
          # Standard RISC-V tests - p-mode only (~94 tests)
          # Note: cv32a65x has no MMU, so only p-mode testlist exists
          - testcase: dv-riscv-tests
            config: cv32a65x
            testlists: "../tests/testlist_riscv-tests-cv32a65x-p.yaml"
          # RISC-V compliance suite (~183 tests)
          - testcase: dv-riscv-compliance
            config: cv32a65x
          # CVA6-specific directed tests (~6 tests)
          - testcase: cv32a6_tests
            config: cv32a65x
          # CSR access verification tests
          - testcase: dv-riscv-csr-access-test
            config: cv32a65x
          # Performance benchmarks (~12 programs)
          - testcase: benchmark
            config: cv32a65x
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup CVA6 Environment
        uses: ./.github/actions/setup-cva6-env

      - name: Install prerequisites
        run: source ci/install-prereq.sh

      - name: Run ${{ matrix.testcase }}
        run: |
          set -x
          source verif/sim/setup-env.sh
          # Override testlists when specified (e.g., cv32a65x has no v-mode tests)
          if [ -n "${{ matrix.testlists }}" ]; then
            export DV_TESTLISTS="${{ matrix.testlists }}"
          fi
          DV_SIMULATORS=veri-testharness,spike \
          DV_TARGET=${{ matrix.config }} \
            bash verif/regress/${{ matrix.testcase }}.sh

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rv32-${{ matrix.config }}-${{ matrix.testcase }}
          path: verif/sim/out*/
          retention-days: 14

  # ============================================================
  # Stage 4: Report Summary
  # ============================================================
  report-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - execute-rv64-tests
      - execute-rv32-tests
    if: ${{ always() && !cancelled() }}
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Generate Summary Report
        run: |
          echo "## OpenHW CVA6 Full APU Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target Arch:** ${{ github.event.inputs.target_arch || 'both' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Arch | Test Suite | Config | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          total_passed=0
          total_failed=0
          total_jobs=0

          # Process each artifact directory
          for dir in artifacts/*/; do
            if [ -d "$dir" ]; then
              name=$(basename "$dir")
              total_jobs=$((total_jobs + 1))

              # Parse name: {arch}-{config}-{testcase}
              arch=$(echo "$name" | cut -d'-' -f1)
              # Extract config and testcase from the name
              remainder=$(echo "$name" | sed "s/^${arch}-//")
              if [[ "$remainder" == cv64a6_imafdc_sv39-* ]]; then
                config="cv64a6_imafdc_sv39"
                testcase=$(echo "$remainder" | sed "s/^cv64a6_imafdc_sv39-//")
              elif [[ "$remainder" == cv32a65x-* ]]; then
                config="cv32a65x"
                testcase=$(echo "$remainder" | sed "s/^cv32a65x-//")
              else
                config="$remainder"
                testcase="-"
              fi

              # Find iss_regr.log
              log_file=$(find "$dir" -name "iss_regr.log" 2>/dev/null | head -1)

              if [ -n "$log_file" ] && [ -f "$log_file" ]; then
                summary_line=$(grep -E "PASSED.*FAILED" "$log_file" | tail -n 1)
                if [ -n "$summary_line" ]; then
                  passed=$(printf "%s" "$summary_line" | sed -n 's/.*\([0-9][0-9]*\)[[:space:]]*PASSED.*/\1/p')
                  failed=$(printf "%s" "$summary_line" | sed -n 's/.*\([0-9][0-9]*\)[[:space:]]*FAILED.*/\1/p')
                else
                  passed=""
                  failed=""
                fi

                if [ -n "$failed" ] && [ "$failed" -gt 0 ]; then
                  status="FAIL ($passed passed, $failed failed)"
                  total_failed=$((total_failed + failed))
                  total_passed=$((total_passed + ${passed:-0}))
                elif [ -n "$passed" ] && [ "$passed" -ge 0 ]; then
                  status="PASS ($passed tests)"
                  total_passed=$((total_passed + passed))
                else
                  status="Unknown"
                fi
              else
                status="No log"
              fi

              echo "| ${arch} | ${testcase} | ${config} | ${status} |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Jobs:** ${total_jobs}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Passed:** ${total_passed}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Failed:** ${total_failed}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by OpenHW CVA6 Full APU CI*" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        run: |
          failed=0
          for dir in artifacts/*/; do
            if [ -d "$dir" ]; then
              log_file=$(find "$dir" -name "iss_regr.log" 2>/dev/null | head -1)
              if [ -n "$log_file" ] && [ -f "$log_file" ]; then
                summary_line=$(grep -E "PASSED.*FAILED" "$log_file" | tail -n 1)
                if [ -n "$summary_line" ]; then
                  failed_count=$(printf "%s" "$summary_line" | sed -n 's/.*\([0-9][0-9]*\)[[:space:]]*FAILED.*/\1/p')
                  if [ -n "$failed_count" ] && [ "$failed_count" -gt 0 ]; then
                    echo "::error::Test failures in $(basename "$dir")"
                    failed=1
                  fi
                fi
              fi
            fi
          done

          if [ "$failed" -eq 1 ]; then
            exit 1
          fi

          echo "All tests passed!"
